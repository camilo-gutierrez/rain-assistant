<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rain Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Dark theme (default) - Cyberpunk */
        :root {
            --bg: #0a0a14;
            --surface: #0f0f1e;
            --surface2: #1a1a2e;
            --overlay: #252540;
            --text: #e0e0f0;
            --text2: #a0a0c0;
            --subtext: #606080;
            --blue: #00d4ff;
            --green: #00ff88;
            --red: #ff2266;
            --yellow: #ffcc00;
            --mauve: #bf5af2;
            --cyan: #00d4ff;
            --magenta: #ff00aa;
            --neon-glow: rgba(0, 212, 255, 0.15);
            --grid-color: rgba(0, 212, 255, 0.03);
        }

        /* Light theme */
        [data-theme="light"] {
            --bg: #e8eaf0;
            --surface: #d8dce6;
            --surface2: #c0c8d8;
            --overlay: #a8b0c4;
            --text: #1a1a2e;
            --text2: #2a2a4e;
            --subtext: #5a5a7e;
            --blue: #0099cc;
            --green: #00aa66;
            --red: #cc1144;
            --yellow: #cc9900;
            --mauve: #8833cc;
            --cyan: #0099cc;
            --magenta: #cc0088;
            --neon-glow: rgba(0, 153, 204, 0.1);
            --grid-color: rgba(0, 153, 204, 0.03);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            background-image:
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--text);
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Scanline overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 212, 255, 0.006) 2px,
                rgba(0, 212, 255, 0.006) 4px
            );
        }

        /* Ambient glow corners */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background:
                radial-gradient(ellipse at 0% 0%, rgba(0, 212, 255, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 100% 100%, rgba(191, 90, 242, 0.06) 0%, transparent 50%);
        }

        /* ---- Status bar ---- */
        #status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--overlay);
            flex-shrink: 0;
            box-shadow: 0 1px 8px var(--neon-glow);
        }

        #connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--subtext);
            transition: all 0.3s;
        }
        #connection-dot.connected {
            background: var(--green);
            box-shadow: 0 0 8px var(--green), 0 0 16px rgba(0, 255, 136, 0.3);
        }
        #connection-dot.error {
            background: var(--red);
            box-shadow: 0 0 8px var(--red), 0 0 16px rgba(255, 34, 102, 0.3);
        }

        #status-text {
            font-size: 13px;
            color: var(--text2);
            flex: 1;
        }

        #status-bar h1 {
            font-family: 'Orbitron', monospace;
            font-size: 15px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--cyan), var(--magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ---- Panels ---- */
        .panel {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        .panel.hidden { display: none; }

        /* ---- File Browser ---- */
        #browser-header {
            padding: 16px;
            border-bottom: 1px solid var(--overlay);
            flex-shrink: 0;
        }

        #browser-header h2 {
            font-size: 18px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            margin-bottom: 8px;
        }

        #current-path {
            font-size: 12px;
            color: var(--subtext);
            word-break: break-all;
            font-family: 'JetBrains Mono', 'Consolas', 'Courier New', monospace;
        }

        #file-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .file-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--surface);
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.15s;
        }

        .file-entry:active { background: var(--surface2); }

        .file-entry .icon {
            font-size: 20px;
            flex-shrink: 0;
            width: 28px;
            text-align: center;
        }

        .file-entry .name {
            flex: 1;
            font-size: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-entry .size {
            font-size: 12px;
            color: var(--subtext);
            flex-shrink: 0;
            font-family: 'JetBrains Mono', monospace;
        }

        .file-entry.directory .name { color: var(--cyan); }
        .file-entry.file .name { color: var(--text2); }

        #select-dir-btn {
            margin: 16px;
            padding: 16px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, var(--cyan), var(--mauve));
            color: var(--bg);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            flex-shrink: 0;
            box-shadow: 0 0 16px rgba(0, 212, 255, 0.2);
            transition: box-shadow 0.3s, transform 0.15s;
        }

        #select-dir-btn:hover {
            box-shadow: 0 0 24px rgba(0, 212, 255, 0.35);
            transform: translateY(-1px);
        }

        #select-dir-btn:disabled {
            background: var(--surface2);
            color: var(--subtext);
            cursor: default;
            box-shadow: none;
        }

        /* ---- Chat Panel ---- */
        #chat-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--overlay);
            flex-shrink: 0;
            gap: 12px;
        }

        #project-name {
            flex: 1;
            font-size: 15px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--cyan);
        }

        #change-dir-btn {
            padding: 6px 14px;
            font-size: 13px;
            background: var(--surface2);
            color: var(--text2);
            border: 1px solid var(--overlay);
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
        }

        #change-dir-btn:hover {
            border-color: var(--cyan);
            color: var(--cyan);
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Message bubbles */
        .msg {
            max-width: 95%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
            animation: msg-appear 0.3s ease-out;
        }

        @keyframes msg-appear {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg.user {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(191, 90, 242, 0.15));
            color: var(--text);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.1);
        }

        .msg.assistant {
            background: var(--surface);
            color: var(--text);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(0, 255, 136, 0.15);
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.05);
        }

        .msg.assistant pre {
            font-family: 'JetBrains Mono', 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .msg.system {
            font-size: 12px;
            color: var(--subtext);
            text-align: center;
            align-self: center;
            font-style: italic;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Tool use blocks */
        .tool-block {
            background: rgba(15, 15, 30, 0.8);
            border-left: 3px solid var(--mauve);
            border-top: 1px solid rgba(191, 90, 242, 0.2);
            border-right: 1px solid rgba(191, 90, 242, 0.1);
            border-bottom: 1px solid rgba(191, 90, 242, 0.1);
            padding: 8px 12px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            align-self: flex-start;
            max-width: 95%;
            box-shadow: 0 0 12px rgba(191, 90, 242, 0.08);
            animation: msg-appear 0.3s ease-out;
        }

        [data-theme="light"] .tool-block {
            background: rgba(200, 208, 224, 0.8);
        }

        .tool-block .tool-header {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--mauve);
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 4px;
            text-shadow: 0 0 8px rgba(191, 90, 242, 0.4);
        }

        .tool-block .tool-detail {
            color: var(--text2);
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tool-result-block {
            background: rgba(15, 15, 30, 0.8);
            border-left: 3px solid var(--green);
            border-top: 1px solid rgba(0, 255, 136, 0.15);
            border-right: 1px solid rgba(0, 255, 136, 0.08);
            border-bottom: 1px solid rgba(0, 255, 136, 0.08);
            padding: 8px 12px;
            border-radius: 0 8px 8px 0;
            font-size: 12px;
            align-self: flex-start;
            max-width: 95%;
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.06);
            animation: msg-appear 0.3s ease-out;
        }

        [data-theme="light"] .tool-result-block {
            background: rgba(200, 208, 224, 0.8);
        }

        .tool-result-block.error {
            border-left-color: var(--red);
            border-top-color: rgba(255, 34, 102, 0.15);
            box-shadow: 0 0 12px rgba(255, 34, 102, 0.08);
        }

        .tool-result-block pre {
            font-family: 'JetBrains Mono', 'Consolas', 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--text2);
            max-height: 120px;
            overflow-y: auto;
        }

        .expand-btn {
            display: inline-block;
            margin-top: 6px;
            padding: 4px 10px;
            font-size: 11px;
            background: var(--surface2);
            color: var(--text2);
            border: 1px solid var(--overlay);
            border-radius: 6px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .expand-btn:hover {
            border-color: var(--cyan);
        }

        /* ---- Controls ---- */
        #controls {
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            background: var(--surface);
            border-top: 1px solid var(--overlay);
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        #record-btn {
            flex: 1;
            padding: 18px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 212, 255, 0.05));
            color: var(--cyan);
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 14px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            transition: all 0.15s;
            position: relative;
            overflow: hidden;
        }

        #record-btn:active:not(:disabled) { transform: scale(0.97); }

        #record-btn.recording {
            background: linear-gradient(135deg, rgba(255, 34, 102, 0.25), rgba(255, 0, 170, 0.1));
            color: var(--red);
            border-color: var(--red);
            box-shadow: 0 0 20px rgba(255, 34, 102, 0.3), 0 0 40px rgba(255, 34, 102, 0.1);
            animation: neon-pulse-red 1.5s ease-in-out infinite;
        }

        #record-btn.processing {
            background: var(--surface2);
            color: var(--subtext);
            border-color: var(--overlay);
            box-shadow: none;
        }

        #record-btn.processing::after {
            content: '';
            display: block;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--cyan), transparent);
            animation: scan-line 2s linear infinite;
        }

        #record-btn:disabled { opacity: 0.5; cursor: default; }

        @keyframes neon-pulse-red {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 34, 102, 0.3), 0 0 40px rgba(255, 34, 102, 0.1); }
            50% { box-shadow: 0 0 30px rgba(255, 34, 102, 0.5), 0 0 60px rgba(255, 34, 102, 0.2); }
        }

        @keyframes scan-line {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        #interrupt-btn {
            padding: 18px 24px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, rgba(255, 34, 102, 0.2), rgba(255, 34, 102, 0.05));
            color: var(--red);
            border: 2px solid var(--red);
            border-radius: 14px;
            cursor: pointer;
            flex-shrink: 0;
            animation: neon-pulse-red 1.5s ease-in-out infinite;
        }

        #interrupt-btn.hidden { display: none; }

        #interrupt-btn.stopping {
            background: var(--overlay);
            color: var(--text2);
            border-color: var(--overlay);
            animation: none;
            cursor: wait;
        }

        #interrupt-btn.force {
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.2), rgba(255, 204, 0, 0.05));
            color: var(--yellow);
            border-color: var(--yellow);
            animation: neon-pulse-yellow 0.8s ease-in-out infinite;
            cursor: pointer;
        }

        @keyframes neon-pulse-yellow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 204, 0, 0.3); }
            50% { box-shadow: 0 0 30px rgba(255, 204, 0, 0.5); }
        }

        /* ---- Text input area ---- */
        #text-input-area {
            display: flex;
            gap: 8px;
            padding: 8px 16px;
            background: var(--surface);
            border-top: 1px solid var(--overlay);
            flex-shrink: 0;
        }

        #text-input {
            flex: 1;
            padding: 10px 14px;
            font-size: 15px;
            background: var(--surface2);
            color: var(--text);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 10px;
            outline: none;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #text-input:focus {
            border-color: var(--cyan);
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.1);
        }

        #text-input::placeholder { color: var(--subtext); }

        #send-text-btn {
            padding: 10px 18px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 255, 136, 0.05));
            color: var(--green);
            border: 1px solid rgba(0, 255, 136, 0.4);
            border-radius: 10px;
            cursor: pointer;
            flex-shrink: 0;
            transition: box-shadow 0.2s;
        }

        #send-text-btn:hover {
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.2);
        }

        #send-text-btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        /* ---- Theme Toggle ---- */
        #theme-toggle {
            background: var(--surface2);
            border: 1px solid var(--overlay);
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: background 0.2s, transform 0.15s, border-color 0.2s;
            flex-shrink: 0;
        }

        #theme-toggle:hover { background: var(--overlay); border-color: var(--cyan); }
        #theme-toggle:active { transform: scale(0.92); }

        /* ---- PIN & API Key Panels ---- */
        #pin-panel,
        #api-key-panel {
            justify-content: center;
            align-items: center;
            padding: 24px;
        }

        .pin-container {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
        }

        .pin-container h2,
        .api-key-container h2 {
            font-family: 'Orbitron', monospace;
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--cyan), var(--magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .pin-container p {
            font-size: 14px;
            color: var(--text2);
            text-align: center;
            line-height: 1.5;
        }

        #pin-input {
            width: 180px;
            padding: 16px;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            letter-spacing: 8px;
            background: var(--surface2);
            color: var(--text);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            outline: none;
            font-family: 'JetBrains Mono', 'Consolas', 'Courier New', monospace;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #pin-input:focus {
            border-color: var(--cyan);
            box-shadow: 0 0 16px rgba(0, 212, 255, 0.15);
        }
        #pin-input::placeholder { color: var(--subtext); letter-spacing: 4px; font-size: 18px; }

        #pin-submit-btn {
            width: 180px;
            padding: 14px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, var(--cyan), var(--mauve));
            color: var(--bg);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 0 16px rgba(0, 212, 255, 0.2);
            transition: box-shadow 0.3s, transform 0.15s;
        }

        #pin-submit-btn:hover {
            box-shadow: 0 0 24px rgba(0, 212, 255, 0.35);
            transform: translateY(-1px);
        }

        #pin-submit-btn:disabled {
            background: var(--surface2);
            color: var(--subtext);
            cursor: default;
            box-shadow: none;
        }

        #pin-error {
            font-size: 13px;
            color: var(--red);
            display: none;
            text-shadow: 0 0 8px rgba(255, 34, 102, 0.3);
        }

        .api-key-container {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .api-key-container p {
            font-size: 14px;
            color: var(--text2);
            text-align: center;
            line-height: 1.5;
        }

        .api-key-input-wrap {
            position: relative;
            display: flex;
        }

        #api-key-input {
            flex: 1;
            padding: 14px 48px 14px 14px;
            font-size: 15px;
            background: var(--surface2);
            color: var(--text);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 10px;
            outline: none;
            font-family: 'JetBrains Mono', 'Consolas', 'Courier New', monospace;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #api-key-input:focus {
            border-color: var(--cyan);
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.1);
        }

        #api-key-input::placeholder { color: var(--subtext); }

        #toggle-key-vis {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--subtext);
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
        }

        #connect-api-btn {
            padding: 16px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, var(--cyan), var(--mauve));
            color: var(--bg);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 0 16px rgba(0, 212, 255, 0.2);
            transition: box-shadow 0.3s, transform 0.15s;
        }

        #connect-api-btn:hover {
            box-shadow: 0 0 24px rgba(0, 212, 255, 0.35);
            transform: translateY(-1px);
        }

        #connect-api-btn:disabled {
            background: var(--surface2);
            color: var(--subtext);
            cursor: default;
            box-shadow: none;
        }

        #skip-api-btn {
            padding: 12px;
            font-size: 14px;
            background: none;
            color: var(--subtext);
            border: 1px solid var(--surface2);
            border-radius: 10px;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
        }

        #skip-api-btn:hover { color: var(--text2); border-color: var(--cyan); }

        .api-key-saved {
            font-size: 12px;
            color: var(--green);
            text-align: center;
        }

        #clear-key-btn {
            background: none;
            border: none;
            color: var(--red);
            cursor: pointer;
            font-size: 12px;
            text-decoration: underline;
        }

        /* ---- Scrollbar ---- */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--cyan), var(--mauve));
            border-radius: 2px;
        }

        /* Smooth theme transition */
        body, #status-bar, #chat-header, #controls, #text-input-area,
        .msg, .tool-block, .tool-result-block, #text-input, .file-entry {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body>

    <!-- Status Bar -->
    <div id="status-bar">
        <span id="connection-dot"></span>
        <h1>Rain Assistant</h1>
        <span id="status-text">Connecting...</span>
        <button id="theme-toggle" title="Toggle light/dark mode">&#127769;</button>
    </div>

    <!-- PIN Panel -->
    <div id="pin-panel" class="panel">
        <div class="pin-container">
            <h2>Rain Assistant</h2>
            <p>Enter the PIN shown on your server console</p>
            <input type="password" inputmode="numeric" maxlength="6" id="pin-input" placeholder="------" autocomplete="off">
            <span id="pin-error">Incorrect PIN</span>
            <button id="pin-submit-btn">Enter</button>
        </div>
    </div>

    <!-- API Key Panel -->
    <div id="api-key-panel" class="panel hidden">
        <div class="api-key-container">
            <h2>Rain Assistant</h2>
            <p>Enter your Anthropic API key to connect. You can get one at
               <a href="https://console.anthropic.com" target="_blank" style="color:var(--cyan)">console.anthropic.com</a></p>
            <div class="api-key-input-wrap">
                <input type="password" id="api-key-input" placeholder="sk-ant-..." autocomplete="off">
                <button id="toggle-key-vis" type="button">Show</button>
            </div>
            <div id="saved-key-info" class="api-key-saved" style="display:none">
                Key saved from last session. <button id="clear-key-btn">Clear</button>
            </div>
            <button id="connect-api-btn">Connect</button>
            <button id="skip-api-btn">Use without key (local mode)</button>
        </div>
    </div>

    <!-- File Browser Panel -->
    <div id="file-browser" class="panel hidden">
        <div id="browser-header">
            <h2>Select Project Directory</h2>
            <div id="current-path">Loading...</div>
        </div>
        <div id="file-list"></div>
        <button id="select-dir-btn">Select This Directory</button>
    </div>

    <!-- Chat Panel -->
    <div id="chat-panel" class="panel hidden">
        <div id="chat-header">
            <span id="project-name"></span>
            <button id="change-dir-btn">Change</button>
        </div>
        <div id="chat-messages"></div>
        <div id="text-input-area">
            <input type="text" id="text-input" placeholder="Type a message..." autocomplete="off">
            <button id="send-text-btn">Send</button>
        </div>
        <div id="controls">
            <button id="record-btn" disabled>Hold to Speak</button>
            <button id="interrupt-btn" class="hidden">Stop</button>
        </div>
    </div>

<script>
// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------

const API = window.location.origin + '/api';
const WS_URL = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws';

let ws = null;
let reconnectTimer = null;
let currentBrowsePath = '~';
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let isProcessing = false;
let interruptPending = false;
let currentAssistantEl = null;
let currentStreamText = '';

// ---------------------------------------------------------------------------
// Storage key migration (from old voice-claude keys)
// ---------------------------------------------------------------------------

(function migrateStorageKeys() {
    const migrations = [
        { old: 'voice-claude-token', new: 'rain-token', storage: sessionStorage },
        { old: 'voice-claude-api-key', new: 'rain-api-key', storage: localStorage },
        { old: 'voice-claude-theme', new: 'rain-theme', storage: localStorage },
    ];
    migrations.forEach(({ old: oldKey, new: newKey, storage }) => {
        const val = storage.getItem(oldKey);
        if (val && !storage.getItem(newKey)) {
            storage.setItem(newKey, val);
            storage.removeItem(oldKey);
        }
    });
})();

// ---------------------------------------------------------------------------
// Notifications
// ---------------------------------------------------------------------------

let notificationsEnabled = false;
let tabFocused = true;
let unreadCount = 0;
const originalTitle = 'Rain Assistant';

document.addEventListener('visibilitychange', () => {
    tabFocused = !document.hidden;
    if (tabFocused) {
        unreadCount = 0;
        document.title = originalTitle;
    }
});

window.addEventListener('focus', () => {
    tabFocused = true;
    unreadCount = 0;
    document.title = originalTitle;
});

window.addEventListener('blur', () => {
    tabFocused = false;
});

function requestNotificationPermission() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'granted') {
        notificationsEnabled = true;
        return;
    }
    if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(perm => {
            notificationsEnabled = (perm === 'granted');
        });
    }
}

// Request permission on first user interaction
['click', 'keydown', 'touchstart'].forEach(evt => {
    document.addEventListener(evt, function onFirstInteraction() {
        requestNotificationPermission();
        document.removeEventListener(evt, onFirstInteraction);
    }, { once: true });
});

function generateRainIcon() {
    const canvas = document.createElement('canvas');
    canvas.width = 64;
    canvas.height = 64;
    const ctx = canvas.getContext('2d');
    ctx.beginPath();
    ctx.arc(32, 32, 30, 0, Math.PI * 2);
    ctx.fillStyle = '#0a0a14';
    ctx.fill();
    ctx.strokeStyle = '#00d4ff';
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.fillStyle = '#00d4ff';
    ctx.font = 'bold 32px Orbitron, monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('R', 32, 34);
    return canvas.toDataURL();
}

let _rainIconDataUrl = null;
function getRainIcon() {
    if (!_rainIconDataUrl) _rainIconDataUrl = generateRainIcon();
    return _rainIconDataUrl;
}

function sendNotification(title, body) {
    if (!notificationsEnabled || tabFocused) return;

    unreadCount++;
    document.title = '(' + unreadCount + ') ' + originalTitle;

    try {
        const notification = new Notification(title, {
            body: (body || '').slice(0, 150),
            icon: getRainIcon(),
            tag: 'rain-response',
            renotify: true,
        });

        notification.onclick = () => {
            window.focus();
            notification.close();
        };

        setTimeout(() => notification.close(), 5000);
    } catch (e) {
        console.warn('Notification failed:', e);
    }
}

// ---------------------------------------------------------------------------
// DOM refs
// ---------------------------------------------------------------------------

const statusDot     = document.getElementById('connection-dot');
const statusText    = document.getElementById('status-text');
const pinPanel      = document.getElementById('pin-panel');
const pinInput      = document.getElementById('pin-input');
const pinSubmitBtn  = document.getElementById('pin-submit-btn');
const pinError      = document.getElementById('pin-error');
const apiKeyPanel   = document.getElementById('api-key-panel');
const apiKeyInput   = document.getElementById('api-key-input');
const toggleKeyVis  = document.getElementById('toggle-key-vis');
const connectApiBtn = document.getElementById('connect-api-btn');
const skipApiBtn    = document.getElementById('skip-api-btn');
const savedKeyInfo  = document.getElementById('saved-key-info');
const clearKeyBtn   = document.getElementById('clear-key-btn');
const fileBrowser   = document.getElementById('file-browser');
const chatPanel     = document.getElementById('chat-panel');
const currentPathEl = document.getElementById('current-path');
const fileList      = document.getElementById('file-list');
const selectDirBtn  = document.getElementById('select-dir-btn');
const projectNameEl = document.getElementById('project-name');
const changeDirBtn  = document.getElementById('change-dir-btn');
const chatMessages  = document.getElementById('chat-messages');
const recordBtn     = document.getElementById('record-btn');
const interruptBtn  = document.getElementById('interrupt-btn');
const textInput     = document.getElementById('text-input');
const sendTextBtn   = document.getElementById('send-text-btn');

// ---------------------------------------------------------------------------
// Auth token
// ---------------------------------------------------------------------------

let authToken = sessionStorage.getItem('rain-token') || null;

function authHeaders() {
    return authToken ? { 'Authorization': 'Bearer ' + authToken } : {};
}

// ---------------------------------------------------------------------------
// PIN
// ---------------------------------------------------------------------------

pinSubmitBtn.addEventListener('click', submitPin);
pinInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); submitPin(); }
});

async function submitPin() {
    const pin = pinInput.value.trim();
    if (!pin) return;
    pinSubmitBtn.disabled = true;
    pinError.style.display = 'none';
    try {
        const res = await fetch(`${API}/auth`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pin }),
        });
        const data = await res.json();
        if (data.token) {
            authToken = data.token;
            sessionStorage.setItem('rain-token', authToken);
            pinPanel.classList.add('hidden');
            apiKeyPanel.classList.remove('hidden');
            connectWS();
        } else {
            pinError.style.display = '';
            pinInput.value = '';
            pinInput.focus();
        }
    } catch (err) {
        pinError.style.display = '';
    }
    pinSubmitBtn.disabled = false;
}

// ---------------------------------------------------------------------------
// API Key
// ---------------------------------------------------------------------------

let usingApiKey = false;

// Restore saved key
const savedKey = localStorage.getItem('rain-api-key');
if (savedKey) {
    apiKeyInput.value = savedKey;
    savedKeyInfo.style.display = '';
}

toggleKeyVis.addEventListener('click', () => {
    const isPassword = apiKeyInput.type === 'password';
    apiKeyInput.type = isPassword ? 'text' : 'password';
    toggleKeyVis.textContent = isPassword ? 'Hide' : 'Show';
});

connectApiBtn.addEventListener('click', () => {
    const key = apiKeyInput.value.trim();
    if (!key) return;
    localStorage.setItem('rain-api-key', key);
    usingApiKey = true;
    wsSend({ type: 'set_api_key', key });
    showFileBrowser();
});

skipApiBtn.addEventListener('click', () => {
    usingApiKey = false;
    showFileBrowser();
});

clearKeyBtn.addEventListener('click', () => {
    localStorage.removeItem('rain-api-key');
    apiKeyInput.value = '';
    savedKeyInfo.style.display = 'none';
});

function showFileBrowser() {
    apiKeyPanel.classList.add('hidden');
    fileBrowser.classList.remove('hidden');
    loadDir('~');
}

// ---------------------------------------------------------------------------
// WebSocket
// ---------------------------------------------------------------------------

function connectWS() {
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }

    const wsUrl = authToken ? WS_URL + '?token=' + encodeURIComponent(authToken) : WS_URL;
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
        setStatus('connected', 'Connected');
        recordBtn.disabled = false;
    };

    ws.onmessage = (e) => {
        try { handleServerMsg(JSON.parse(e.data)); }
        catch (err) { console.error('WS parse error:', err); }
    };

    ws.onclose = (e) => {
        setStatus('disconnected', 'Disconnected');
        recordBtn.disabled = true;
        if (e.code === 4001) {
            // Token rejected -- clear and show PIN
            authToken = null;
            sessionStorage.removeItem('rain-token');
            apiKeyPanel.classList.add('hidden');
            fileBrowser.classList.add('hidden');
            chatPanel.classList.add('hidden');
            pinPanel.classList.remove('hidden');
            pinError.style.display = '';
            return;
        }
        reconnectTimer = setTimeout(connectWS, 3000);
    };

    ws.onerror = () => ws.close();
}

function wsSend(obj) {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(obj));
    }
}

// ---------------------------------------------------------------------------
// Status
// ---------------------------------------------------------------------------

function setStatus(state, text) {
    statusDot.className = '';
    if (state === 'connected' || state === 'ready') statusDot.classList.add('connected');
    else if (state === 'error') statusDot.classList.add('error');
    statusText.textContent = text;
}

// ---------------------------------------------------------------------------
// File Browser
// ---------------------------------------------------------------------------

async function loadDir(path) {
    try {
        const res = await fetch(`${API}/browse?path=${encodeURIComponent(path)}`, { headers: authHeaders() });
        const data = await res.json();

        if (data.error) {
            setStatus('error', data.error);
            return;
        }

        currentBrowsePath = data.current;
        currentPathEl.textContent = data.current;
        fileList.innerHTML = '';

        for (const entry of data.entries) {
            const div = document.createElement('div');
            div.className = 'file-entry ' + (entry.is_dir ? 'directory' : 'file');

            const icon = document.createElement('span');
            icon.className = 'icon';
            icon.textContent = entry.name === '..' ? '\u2B06' : entry.is_dir ? '\uD83D\uDCC1' : '\uD83D\uDCC4';

            const name = document.createElement('span');
            name.className = 'name';
            name.textContent = entry.name;

            div.appendChild(icon);
            div.appendChild(name);

            if (!entry.is_dir && entry.size > 0) {
                const size = document.createElement('span');
                size.className = 'size';
                size.textContent = formatSize(entry.size);
                div.appendChild(size);
            }

            if (entry.is_dir) {
                div.addEventListener('click', () => loadDir(entry.path));
            }

            fileList.appendChild(div);
        }
    } catch (err) {
        setStatus('error', 'Failed to load directory');
    }
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}

selectDirBtn.addEventListener('click', () => {
    wsSend({ type: 'set_cwd', path: currentBrowsePath });
    fileBrowser.classList.add('hidden');
    chatPanel.classList.remove('hidden');
    projectNameEl.textContent = currentBrowsePath.split(/[/\\]/).pop();
});

changeDirBtn.addEventListener('click', () => {
    chatPanel.classList.add('hidden');
    fileBrowser.classList.remove('hidden');
    loadDir(currentBrowsePath);
});

// ---------------------------------------------------------------------------
// Audio recording
// ---------------------------------------------------------------------------

async function initAudio() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            audio: { channelCount: 1, echoCancellation: true, noiseSuppression: true }
        });

        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
            ? 'audio/webm;codecs=opus'
            : MediaRecorder.isTypeSupported('audio/webm')
                ? 'audio/webm'
                : MediaRecorder.isTypeSupported('audio/mp4')
                    ? 'audio/mp4'
                    : '';

        const options = mimeType ? { mimeType } : {};
        mediaRecorder = new MediaRecorder(stream, options);

        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) audioChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
            const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
            audioChunks = [];
            if (blob.size < 3000) {
                setStatus('ready', 'Recording too short');
                resetRecordBtn();
                return;
            }
            await sendAudio(blob);
        };

        recordBtn.disabled = false;
    } catch (err) {
        console.error('Audio init error:', err);
        recordBtn.textContent = 'Mic unavailable';
        recordBtn.disabled = true;
    }
}

function startRecording() {
    if (isRecording || isProcessing || !mediaRecorder) return;
    audioChunks = [];
    mediaRecorder.start(100);
    isRecording = true;
    recordBtn.textContent = 'Recording... Release to Send';
    recordBtn.classList.add('recording');
}

function stopRecording() {
    if (!isRecording || !mediaRecorder) return;
    mediaRecorder.stop();
    isRecording = false;
    recordBtn.textContent = 'Transcribing...';
    recordBtn.classList.remove('recording');
    recordBtn.classList.add('processing');
    recordBtn.disabled = true;
}

async function sendAudio(blob) {
    setStatus('connected', 'Transcribing...');
    const fd = new FormData();
    fd.append('audio', blob, 'recording.webm');

    try {
        const res = await fetch(`${API}/upload-audio`, { method: 'POST', body: fd, headers: authHeaders() });
        const data = await res.json();

        if (data.text && data.text.trim()) {
            appendMsg('user', data.text.trim());
            sendToRainViaWS(data.text.trim());
        } else {
            setStatus('ready', 'No speech detected');
            resetRecordBtn();
        }
    } catch (err) {
        setStatus('error', 'Transcription failed');
        resetRecordBtn();
    }
}

// Touch + mouse events for push-to-talk
recordBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); }, { passive: false });
recordBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopRecording(); }, { passive: false });
recordBtn.addEventListener('mousedown', startRecording);
recordBtn.addEventListener('mouseup', stopRecording);
recordBtn.addEventListener('mouseleave', () => { if (isRecording) stopRecording(); });

// ---------------------------------------------------------------------------
// Text input
// ---------------------------------------------------------------------------

sendTextBtn.addEventListener('click', sendTextMessage);
textInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendTextMessage();
    }
});

function sendTextMessage() {
    const text = textInput.value.trim();
    if (!text || isProcessing) return;
    appendMsg('user', text);
    sendToRainViaWS(text);
    textInput.value = '';
}

// ---------------------------------------------------------------------------
// Send to Rain via WS
// ---------------------------------------------------------------------------

function sendToRainViaWS(text) {
    isProcessing = true;
    recordBtn.textContent = 'Rain is working...';
    recordBtn.classList.add('processing');
    recordBtn.disabled = true;
    sendTextBtn.disabled = true;
    interruptBtn.classList.remove('hidden');
    wsSend({ type: 'send_message', text });
}

// ---------------------------------------------------------------------------
// Handle server messages
// ---------------------------------------------------------------------------

function handleServerMsg(msg) {
    switch (msg.type) {
        case 'status':
            setStatus('connected', msg.text);
            if (msg.cwd) {
                projectNameEl.textContent = msg.cwd.split(/[/\\]/).pop();
            }
            break;

        case 'assistant_text':
            ensureAssistantBubble();
            currentStreamText += msg.text;
            currentAssistantEl.innerHTML = renderMarkdown(currentStreamText);
            scrollToBottom();
            break;

        case 'stream_text':
            ensureAssistantBubble();
            currentStreamText += msg.text;
            currentAssistantEl.innerHTML = renderMarkdown(currentStreamText);
            scrollToBottom();
            break;

        case 'tool_use':
            finalizeAssistant();
            appendToolUse(msg.tool, msg.input);
            break;

        case 'tool_result':
            appendToolResult(msg.content, msg.is_error);
            break;

        case 'result':
            finalizeAssistant();
            if (msg.cost != null || msg.duration_ms != null) {
                let info = '';
                if (msg.duration_ms) info += (msg.duration_ms / 1000).toFixed(1) + 's';
                if (msg.num_turns) info += ' | ' + msg.num_turns + ' turns';
                if (msg.cost) info += ' | $' + msg.cost.toFixed(4);
                if (info) appendMsg('system', info);
            }
            sendNotification('Rain has finished', msg.text || 'Response complete');
            resetRecordBtn();
            isProcessing = false;
            interruptPending = false;
            sendTextBtn.disabled = false;
            interruptBtn.classList.add('hidden');
            interruptBtn.classList.remove('force', 'stopping');
            interruptBtn.textContent = 'Stop';
            interruptBtn.disabled = false;
            setStatus('connected', 'Ready');
            break;

        case 'error':
            finalizeAssistant();
            appendMsg('system', 'Error: ' + msg.text);
            sendNotification('Rain needs attention', 'Error: ' + (msg.text || 'Unknown error'));
            resetRecordBtn();
            isProcessing = false;
            interruptPending = false;
            sendTextBtn.disabled = false;
            interruptBtn.classList.add('hidden');
            interruptBtn.classList.remove('force', 'stopping');
            interruptBtn.textContent = 'Stop';
            interruptBtn.disabled = false;
            setStatus('error', msg.text);
            break;
    }
}

// ---------------------------------------------------------------------------
// Chat helpers
// ---------------------------------------------------------------------------

function ensureAssistantBubble() {
    if (!currentAssistantEl) {
        currentAssistantEl = document.createElement('div');
        currentAssistantEl.className = 'msg assistant';
        chatMessages.appendChild(currentAssistantEl);
        currentStreamText = '';
    }
}

function finalizeAssistant() {
    if (currentAssistantEl) {
        currentAssistantEl.innerHTML = renderMarkdown(currentStreamText);
        currentAssistantEl = null;
        currentStreamText = '';
    }
}

function appendMsg(role, text) {
    const div = document.createElement('div');
    div.className = 'msg ' + role;
    if (role === 'assistant') {
        div.innerHTML = renderMarkdown(text);
    } else {
        div.textContent = text;
    }
    chatMessages.appendChild(div);
    scrollToBottom();
}

function appendToolUse(tool, input) {
    const div = document.createElement('div');
    div.className = 'tool-block';

    let summary = '';
    switch (tool) {
        case 'Read':    summary = input.file_path || ''; break;
        case 'Write':   summary = input.file_path || ''; break;
        case 'Edit':    summary = input.file_path || ''; break;
        case 'Bash':    summary = input.command || ''; break;
        case 'Glob':    summary = input.pattern || ''; break;
        case 'Grep':    summary = input.pattern || ''; break;
        default:        summary = JSON.stringify(input).slice(0, 100);
    }

    div.innerHTML =
        '<div class="tool-header">' + escapeHtml(tool) + '</div>' +
        '<div class="tool-detail">' + escapeHtml(summary) + '</div>';
    chatMessages.appendChild(div);
    scrollToBottom();
}

function appendToolResult(content, isError) {
    const div = document.createElement('div');
    div.className = 'tool-result-block' + (isError ? ' error' : '');

    const maxLen = 300;
    const truncated = content && content.length > maxLen;
    const display = truncated ? content.slice(0, maxLen) + '...' : (content || '');

    const pre = document.createElement('pre');
    pre.textContent = display;
    div.appendChild(pre);

    if (truncated) {
        const btn = document.createElement('button');
        btn.className = 'expand-btn';
        btn.textContent = 'Show full output';
        btn.addEventListener('click', () => {
            pre.textContent = content;
            pre.style.maxHeight = 'none';
            btn.remove();
        });
        div.appendChild(btn);
    }

    chatMessages.appendChild(div);
    scrollToBottom();
}

function resetRecordBtn() {
    recordBtn.textContent = 'Hold to Speak';
    recordBtn.className = '';
    recordBtn.disabled = false;
}

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

function renderMarkdown(text) {
    // Minimal markdown: code blocks, inline code, bold, newlines
    let html = escapeHtml(text);
    // Code blocks
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre>$2</pre>');
    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code style="background:var(--surface2);padding:2px 5px;border-radius:4px;font-size:13px;font-family:\'JetBrains Mono\',monospace;">$1</code>');
    // Bold
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    // Newlines
    html = html.replace(/\n/g, '<br>');
    return html;
}

// ---------------------------------------------------------------------------
// Interrupt
// ---------------------------------------------------------------------------

interruptBtn.addEventListener('click', () => {
    if (interruptBtn.classList.contains('force')) {
        forceReset();
        return;
    }
    wsSend({ type: 'interrupt' });
    interruptBtn.textContent = 'Stopping...';
    interruptBtn.classList.add('stopping');
    interruptBtn.disabled = true;
    interruptPending = true;

    setTimeout(() => {
        if (interruptPending && isProcessing) {
            interruptBtn.textContent = 'Force Stop';
            interruptBtn.disabled = false;
            interruptBtn.classList.remove('stopping');
            interruptBtn.classList.add('force');
        }
    }, 5000);
});

function forceReset() {
    finalizeAssistant();
    appendMsg('system', 'Force stopped.');
    resetRecordBtn();
    isProcessing = false;
    interruptPending = false;
    sendTextBtn.disabled = false;
    interruptBtn.classList.add('hidden');
    interruptBtn.classList.remove('force', 'stopping');
    interruptBtn.textContent = 'Stop';
    interruptBtn.disabled = false;
    setStatus('connected', 'Ready');
}

// ---------------------------------------------------------------------------
// Theme Toggle
// ---------------------------------------------------------------------------

const themeToggle = document.getElementById('theme-toggle');

function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    themeToggle.textContent = theme === 'light' ? '\u2600\uFE0F' : '\uD83C\uDF19';
    localStorage.setItem('rain-theme', theme);
}

// Load saved theme or default to dark
const savedTheme = localStorage.getItem('rain-theme') || 'dark';
setTheme(savedTheme);

themeToggle.addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme');
    setTheme(current === 'light' ? 'dark' : 'light');
});

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------

if (authToken) {
    // Already have a token from previous session -- skip PIN, go to API key
    pinPanel.classList.add('hidden');
    apiKeyPanel.classList.remove('hidden');
    connectWS();
}

initAudio();

</script>
</body>
</html>
